I"<p>A few days ago, Microsoft announced the preview of direct-upload to Azure Managed Disks. So, there are two ways you could move a VHD to the Azure cloud as a managed disk:</p>
<ol>
  <li>Upload the VHD in a storage account, and then convert it into a managed disk.</li>
  <li>Create and attach empty managed disk to a VM, and then do the copy.</li>
</ol>

<p>As stated by <a href="https://azure.microsoft.com/en-us/blog/author/ramankum/" target="_blank">Raman Kumar</a>, a Principal Project Manager at Azure, these two ways have disadvantages. The first scenario requires extra storage account management, while the second scenario has extra cost because of a running virtual machine. Direct-upload allows copying an on-premise VHD directly to the Azure cloud as a managed disk, which reduces the cost and the management issues mentioned earlier.<br />
Currently, you can direct-upload to standard HDD, standard SSD, and premium SSD managed disks of all supported sizes.</p>

<p>Direct-Upload can be approached using <a href="https://azure.microsoft.com/en-us/features/storage-explorer/" target="_blank"><strong>Azure Storage Explorer</strong></a> via GUI, which is basically a standalone app, or if you are more of a developer, or DevOps guy, you could use a Rest API or Azure CLI with AzCopy command-line utility. I have already covered AWS to Azure migration topic on this <a href="{% post_url 2019-10-03-how-to-copy-from-aws-s3-bucket-to-azure-blob-storage %}" target="_blank">post</a>. Today, we are going to use Azure CLI in combination with AzCopy.</p>

<p>Check the official blog <a href="https://azure.microsoft.com/en-us/blog/introducing-the-preview-of-direct-upload-to-azure-managed-disks" target="_blank">Introducing the preview of direct-upload to Azure managed disks</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>
<ul>
  <li>Azure account</li>
  <li>Azure Storage account</li>
</ul>

<p>{% include in-article-ad.html %}</p>

<h2 id="create-an-azure-managed-disk">Create an Azure Managed Disk</h2>
<p><strong>Step 1</strong>. Open <em>Terminal</em> and login to the Azure Portal:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az login
</code></pre></div></div>
<p>It will open a new window using the default browser where you will be prompted for email and password.</p>

<p><strong>Step 2</strong>. Create a resource group:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az group create <span class="nt">--name</span> <span class="s2">"managed-disks-rg"</span> <span class="nt">--location</span> westeurope
</code></pre></div></div>

<p><strong>Step 3</strong>. Create a empty managed disk:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az disk create <span class="nt">--name</span> <span class="s2">"myfirstmanageddisk"</span> <span class="nt">--resource-group</span> <span class="s2">"managed-disks-rg"</span> <span class="nt">--location</span> westeurope <span class="nt">--for-upload</span> <span class="nt">--upload-size-bytes</span> 34359738880 <span class="nt">--sku</span> <span class="s2">"standard_lrs"</span>
</code></pre></div></div>
<p>Parameters:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">--name</code>: name of the managed disk.</li>
  <li><code class="language-plaintext highlighter-rouge">--resource-group</code>: name of the managed diskâ€™s resource group.</li>
  <li><code class="language-plaintext highlighter-rouge">--location</code>: location of the managed disk.</li>
  <li><code class="language-plaintext highlighter-rouge">--for-upload</code>: creates a disk for uploading purposes.</li>
  <li><code class="language-plaintext highlighter-rouge">--upload-size-bytes</code>: the file size (in bytes) of the VHD you want to upload.</li>
  <li><code class="language-plaintext highlighter-rouge">--sku</code>: storage SKU.</li>
</ul>

<p><strong>Step 4</strong>. Next, create a writable shared access signature (SAS) of your empty managed disk:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az disk grant-access <span class="nt">--name</span> <span class="s2">"myfirstmanageddisk"</span> <span class="nt">--resource-group</span> <span class="s2">"managed-disks-rg"</span> <span class="nt">--access-level</span> Write <span class="nt">--duration-in-seconds</span> 86400
</code></pre></div></div>
<p>The parameters are self-explanatory. Output will be in json format. For example:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"accessSas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://md-impexp-wjjjpktbq2st.blob.core.windows.net/vh3sfg1tc3tj/abcd?sv=2017-04-17&amp;sr=b&amp;si=c71a65c4-1a3a-49c0-9f5b-d884b8c6c384&amp;sig=cvswkCDM5tW4SNJe7g9O0CNaVYaIgr4IHoKzi7NP3dA%3D"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Step 5</strong>. Now that you have writable SAS, you can upload a VHD using AzCopy tool:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>azcopy copy <span class="s2">"VHDs/managedDisk1.vhd"</span> <span class="s2">"&lt;insert_the_sas_token_output_here&gt;"</span> <span class="nt">--blob-type</span> PageBlob
</code></pre></div></div>

<p><strong>Step 6</strong>. Once the upload completed, you can revoke the SAS, so it allows you to attach a managed disk to a VM:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az disk revoke-access <span class="nt">--name</span> <span class="s2">"myfirstmanageddisk"</span> <span class="nt">--resource-group</span> <span class="s2">"managed-disks-rg"</span>
</code></pre></div></div>

<p>Now, you can attach the managed disk to a virtual machine.</p>

<h2 id="cleaning-up">Cleaning up</h2>

<p><strong>Step 7</strong>. Delete the managed disk:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az disk delete <span class="nt">--name</span> <span class="s2">"myfirstmanageddisk"</span> <span class="nt">--resource-group</span> <span class="s2">"managed-disks-rg"</span>
</code></pre></div></div>

<p><strong>Step 8</strong>. Delete the resource group:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az group delete <span class="nt">--name</span> <span class="s2">"managed-disks-rg"</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>
<p>If you are working with IaaS Virtual Machines, using Direct-Upload is a recommended way to do it, because it will save you a lot of time in a backup and restore, disaster and recovery scenarios.</p>
:ET