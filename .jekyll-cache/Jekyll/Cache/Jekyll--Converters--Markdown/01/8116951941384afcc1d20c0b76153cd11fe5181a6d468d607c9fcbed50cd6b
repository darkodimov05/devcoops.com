I"¯ <p>Managing Azure Virtual Machines through the Portal could be pretty straighforward. But, it requires multiple steps using the GUI. For example, you‚Äôll have to login to the Portal first, then go to the <code class="language-plaintext highlighter-rouge">Azure Virtual Machines</code> service, select the VMs, and then you can start, stop, restart, or even delete the virtual machines. There is also a quicker way to do these operations, especially if you are the SysOps / DevOps guy.<br />
Although, there are three other ways to manage Azure VMs, including PowerShell cmdlets, ARM templates, and the Azure CLI, today i‚Äôll focus on the CLI.</p>

<h2 id="prerequisites">Prerequisites</h2>
<ul>
  <li>Azure account</li>
  <li>Azure VMs</li>
</ul>

<p>{% include in-article-ad.html %}</p>

<h2 id="list-azure-vm-using-the-cli">List Azure VM using the CLI</h2>
<p><strong>Step 1</strong>. Open <em>Terminal</em> and login to the Azure Portal:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az login
</code></pre></div></div>
<p>It will open a new window using the default browser, where you will be prompted for email and password.</p>

<p><strong>Step 2</strong>. Now, we need the list of Azure Virtual machines ids:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm list <span class="nt">--query</span> <span class="s2">"[].id"</span> <span class="nt">--output</span> tsv
</code></pre></div></div>
<p>Parameters:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">--query</code>: parameter to select only the IDs of all virtual machines.</li>
  <li><code class="language-plaintext highlighter-rouge">--output</code>: output the results in a tab-seperated format.</li>
</ul>

<p>Example output:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">/subscription/&lt;SUBSCRIPTION_ID&gt;/resourceGroups/AZURE-VMS-RG/providers/Microsoft.Compute/virtualMachines/web-server</span><span class="mi">-1</span><span class="w">
</span><span class="err">/subscription/&lt;SUBSCRIPTION_ID&gt;/resourceGroups/AZURE-VMS-RG/providers/Microsoft.Compute/virtualMachines/web-server</span><span class="mi">-2</span><span class="w">
</span></code></pre></div></div>

<h2 id="start-azure-vms">Start Azure VMs</h2>
<p><strong>Step 3</strong>. Start a single Azure VM instance:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm start <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--name</span> <span class="s2">"&lt;name_of_vm_instance&gt;"</span>
</code></pre></div></div>

<p><strong>Step 4</strong>. Start all Azure VM instances:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm start <span class="nt">--ids</span> <span class="si">$(</span>az vm list <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--query</span> <span class="s2">"[].id"</span> <span class="nt">--output</span> tsv<span class="si">)</span>
</code></pre></div></div>

<h2 id="stop-azure-vms">Stop Azure VMs</h2>
<p><strong>Step 5</strong>. Stop a single Azure VM instance:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm stop <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--name</span> <span class="s2">"&lt;name_of_vm_instance&gt;"</span>
</code></pre></div></div>

<p><strong>Step 6</strong>. Stop all Azure VM instances:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm stop <span class="nt">--ids</span> <span class="si">$(</span>az vm list <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--query</span> <span class="s2">"[].id"</span> <span class="nt">--output</span> tsv<span class="si">)</span>
</code></pre></div></div>

<p><strong>Note</strong>: Stopping a virtual machine will still generate costs, because you are holding on the VM‚Äôs resources, like: CPU, Memory, Disk, and so on. You could save money by deallocation, using the <code class="language-plaintext highlighter-rouge">az vm deallocate</code> command. For example:<br />
<strong>Step 7</strong>. Deallocate a single VM:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm deallocate <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--name</span> <span class="s2">"&lt;name_of_vm_instance&gt;"</span>
</code></pre></div></div>

<p><strong>Step 8</strong>. Deallocate all VMs:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm deallocate <span class="nt">--ids</span> <span class="si">$(</span>az vm list <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--query</span> <span class="s2">"[].id"</span> <span class="nt">--output</span> tsv<span class="si">)</span>
</code></pre></div></div>

<h2 id="restart-azure-vms">Restart Azure VMs</h2>
<p><strong>Step 9</strong>. Restart a single Azure VM instance:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm restart <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--name</span> <span class="s2">"&lt;name_of_vm_instance&gt;"</span>
</code></pre></div></div>

<p><strong>Step 10</strong>. Restart all Azure VM instances:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm restart <span class="nt">--ids</span> <span class="si">$(</span>az vm list <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--query</span> <span class="s2">"[].id"</span> <span class="nt">--output</span> tsv<span class="si">)</span>
</code></pre></div></div>

<h2 id="delete-azure-vms">Delete Azure VMs</h2>
<p><strong>Step 11</strong>. Delete a single Azure VM instance:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm delete <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--name</span> <span class="s2">"&lt;name_of_vm_instance&gt;"</span>
</code></pre></div></div>

<p><strong>Step 12</strong>. Delete all Azure VM instances:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm delete <span class="nt">--ids</span> <span class="si">$(</span>az vm list <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--query</span> <span class="s2">"[].id"</span> <span class="nt">--output</span> tsv<span class="si">)</span>
</code></pre></div></div>

<p>Also, there is a way, if you want to manage a couple of virtual machines, by filtering the results using the pipe character <code class="language-plaintext highlighter-rouge">|</code> and the <code class="language-plaintext highlighter-rouge">grep</code> command. For example, if i want to delete VMs that include the ‚Äúdev‚Äù string, i‚Äôll execute something like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az vm delete <span class="nt">--ids</span> <span class="si">$(</span>az vm list <span class="nt">--resource-group</span> <span class="s2">"azure-vms-rg"</span> <span class="nt">--query</span> <span class="s2">"[].id"</span> <span class="nt">--output</span> tsv<span class="si">)</span> | <span class="nb">grep</span> <span class="s2">"dev"</span>
</code></pre></div></div>

<p>It goes the same for start, stop, restart, and deallocate operations.</p>

<p>Official documentation <a href="https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest" target="_blank">az vm</a>.</p>

<h2 id="conclusion">Conclusion</h2>
<p>Managing <code class="language-plaintext highlighter-rouge">Azure Virtual Machines</code> through the Azure CLI could save you a lot of time, and you‚Äôll be more productive. But, you should always be careful when executing these commands, especially when running the <strong>delete</strong> command.</p>
:ET